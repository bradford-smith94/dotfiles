#!/bin/bash
# Bradford Smith
# ~/bin/git-summary
# 06/30/2017
# Print a summary of git author contributions

# shellcheck disable=2034
USAGE="[<author>]"

# shellcheck source=/dev/null
source "$(git --exec-path)/git-sh-setup"

require_work_tree

function _summary() {
    if [ -n "$1" ]; then
        #author provided
        AUTHORS=$(git log -i -1 --pretty="format:%aN" --author="$1")
        if [ -z "$AUTHORS" ]; then
            die "fatal: ambiguous argument '$1': unknown author."
        fi
    else
        #no author provided, run for all of them
        AUTHORS=$(git shortlog -n -s --no-merges | colrm 1 8)
    fi

    while read -r author; do
        commits=$(git shortlog -s --author="$author" | tr -dc '0-9')
        files=$(git log --no-merges --use-mailmap --author="$author" --name-only --pretty=format:"" | sort -u | sed '/^$/d' | wc -l | tr -d '\n')
        printf "%s: %'d commits\n%'d files changed, " "$author" "$commits" "$files"
        git log --author="$author" --pretty=tformat: --numstat | awk '{ add += $1; subs += $2 } END { printf "%s addition(s), %s deletion(s)\n", add, subs }'
    done <<< "$AUTHORS"
}

_summary "$1"
